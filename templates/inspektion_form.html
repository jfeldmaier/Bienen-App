{% extends "base.html" %}
{% block title %}Neue Inspektion ¬∑ Bienen-App{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <h1 class="h3 mb-4">üìù Neue Inspektion anlegen</h1>
            <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                {{ form.hidden_tag() }}

                <div class="mb-3">
                    <label for="colony_id" class="form-label">Volk</label>
                    <select name="colony_id" id="colony_id" class="form-select" required>
                        <option disabled value>-- Volk ausw√§hlen --</option>
                        {% for volk in voelker %}
                        <option value="{{ volk.id }}" {% if form.colony_id.data == volk.id %}selected{% endif %}>{{ volk.name }}</option>
                        {% endfor %}
                    </select>
                </div>

  <div class="form-floating mb-3">
    {{ form.date(class="form-control", id="date", placeholder="Datum") }}
    <label for="date">Datum</label>
  </div>

  <!-- Volksst√§rke Rating -->
  <div class="form-group mb-3">
    <label>Volksst√§rke</label>
    <div class="rating editable">
      {% for i in range(5, 0, -1) %}
        <input type="radio" name="volksstaerke" value="{{ i }}" id="volksstaerke-{{ i }}" {% if form.volksstaerke.data == i %}checked{% endif %}>
        <label for="volksstaerke-{{ i }}"></label>
      {% endfor %}
    </div>
  </div>

  <!-- Sanftmut Rating -->
  <div class="form-group mb-3">
    <label>Sanftmut</label>
    <div class="rating editable">
      {% for i in range(5, 0, -1) %}
        <input type="radio" name="sanftmut" value="{{ i }}" id="sanftmut-{{ i }}" {% if form.sanftmut.data == i %}checked{% endif %}>
        <label for="sanftmut-{{ i }}"></label>
      {% endfor %}
    </div>
  </div>

  <!-- Vitalit√§t Rating -->
  <div class="form-group mb-3">
    <label>Vitalit√§t</label>
    <div class="rating editable">
      {% for i in range(5, 0, -1) %}
        <input type="radio" name="vitalitaet" value="{{ i }}" id="vitalitaet-{{ i }}" {% if form.vitalitaet.data == i %}checked{% endif %}>
        <label for="vitalitaet-{{ i }}"></label>
      {% endfor %}
    </div>
  </div>

  <!-- Brut Rating -->
  <div class="form-group mb-3">
    <label>Brut</label>
    <div class="rating editable">
      {% for i in range(5, 0, -1) %}
        <input type="radio" name="brut" value="{{ i }}" id="brut-{{ i }}" {% if form.brut.data == i %}checked{% endif %}>
        <label for="brut-{{ i }}"></label>
      {% endfor %}
    </div>
  </div>

  <div class="form-check mb-3">
    {{ form.queen_seen(class="form-check-input", id="queen_seen") }}
    <label class="form-check-label" for="queen_seen">
      K√∂nigin gesichtet?
    </label>
  </div>

  <div class="form-check mb-3">
    {{ form.drohnenbrut_geschnitten(class="form-check-input", id="drohnenbrut_geschnitten") }}
    <label class="form-check-label" for="drohnenbrut_geschnitten">
      Drohnenbrut geschnitten?
    </label>
  </div>

  <div class="form-floating mb-3">
    {{ form.notes(class="form-control", placeholder="Beobachtungen") }}
    <label for="notes">Beobachtungen</label>
  </div>

  <!-- Bestehende Bilder anzeigen (nur beim Bearbeiten) -->
  {% if bearbeiten is defined and bearbeiten and inspektion is defined and inspektion.images %}
  <div class="mb-3">
    <label class="form-label">üì∏ Vorhandene Bilder ({{ inspektion.images|length }})</label>
    <div class="d-flex gap-2 flex-wrap">
      {% for image in inspektion.images %}
      <div class="position-relative border rounded p-1" style="max-width: 140px;" id="image-{{ image.id }}">
        <a href="{{ url_for('uploaded_inspection_image', date=inspektion.date.strftime('%Y%m%d'), filename=image.filename) }}"
           target="_blank" title="Bild in voller Gr√∂√üe anzeigen">
          <img src="{{ url_for('uploaded_inspection_image', date=inspektion.date.strftime('%Y%m%d'), filename=image.filename) }}"
               alt="Inspektionsfoto" class="img-thumbnail border-0"
               style="width: 100%; height: auto; max-height: 100px; object-fit: cover;">
        </a>
        <button type="button" class="btn btn-danger btn-sm w-100 mt-1 btn-delete-image" style="font-size: 0.7rem;"
                data-image-id="{{ image.id }}" data-filename="{{ image.filename }}">
          üóëÔ∏è L√∂schen
        </button>
        <small class="d-block text-muted text-center" style="font-size: 0.7rem;">
          {{ image.uploaded_at.strftime('%d.%m.%Y') }}
        </small>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Inspektionsbilder hochladen -->
  <div class="mb-3">
    <label for="images" class="form-label">üì∏ {% if bearbeiten is defined and bearbeiten %}Weitere Bilder hinzuf√ºgen{% else %}Inspektionsbilder (optional){% endif %}</label>
    <input type="file" name="images" id="images" class="form-control" multiple accept="image/*" 
           title="JPG, PNG, GIF, WebP bis 5 MB pro Bild">
    <small class="form-text text-muted d-block mt-1">
      Sie k√∂nnen mehrere Bilder gleichzeitig hochladen (JPG, PNG, GIF, WebP). Max. 5 MB pro Bild.
    </small>
  </div>

  <!-- Button zum Einblenden der Zusatzfelder -->
  <button type="button" class="btn btn-link btn-sm mb-3" id="toggle-extra-fields">
    Weitere Felder anzeigen
  </button>

  <div id="extra-fields" style="display:none;">
    <div class="form-floating mb-3">
      {{ form.varroa_check(class="form-control", placeholder="Varroa-Kontrolle (optional)") }}
      <label for="varroa_check">Varroa-Kontrolle (optional)</label>
    </div>
    <div class="form-floating mb-3">
      {{ form.honey_yield(class="form-control", placeholder="Honigertrag (kg)") }}
      <label for="honey_yield">Honigertrag (kg)</label>
    </div>
    <div class="form-floating mb-3">
      <input type="number" name="mittelwaende" class="form-control" id="mittelwaende" placeholder="Mittelw√§nde">
      <label for="mittelwaende">Mittelw√§nde (Anzahl)</label>
    </div>
    <div class="form-floating mb-3">
      <input type="number" name="brutwaben" class="form-control" id="brutwaben" placeholder="Brutwaben">
      <label for="brutwaben">Brutwaben (Anzahl)</label>
    </div>
    <div class="form-floating mb-3">
      <input type="number" name="futterwaben" class="form-control" id="futterwaben" placeholder="Futterwaben">
      <label for="futterwaben">Futterwaben (Anzahl)</label>
    </div>
  </div>

  <div class="d-flex gap-2 mt-4">
    <button type="submit" class="btn btn-primary btn-sm">‚ûï Inspektion speichern</button>
    <a href="{{ url_for('home') }}" class="btn btn-outline-secondary btn-sm">Zur√ºck</a>
  </div>
</form>

{% block scripts %}
{{ super() }}
<script nonce="{{ csp_nonce() }}">
document.getElementById('toggle-extra-fields').addEventListener('click', function() {
  var extra = document.getElementById('extra-fields');
  if (extra.style.display === 'none') {
    extra.style.display = 'block';
    this.textContent = 'Weitere Felder ausblenden';
  } else {
    extra.style.display = 'none';
    this.textContent = 'Weitere Felder anzeigen';
  }
});

document.querySelectorAll('.btn-delete-image').forEach(function(btn) {
  btn.addEventListener('click', function() {
    var imageId = this.getAttribute('data-image-id');
    var filename = this.getAttribute('data-filename');
    if (!confirm('Bild "' + filename + '" wirklich l√∂schen?')) return;
    this.disabled = true;
    this.textContent = '...';
    var self = this;
    fetch('/inspektion/bild/' + imageId + '/loeschen', {
      method: 'POST',
      headers: {'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value}
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        var el = document.getElementById('image-' + imageId);
        if (el) el.remove();
      } else {
        alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
      }
    })
    .catch(function() { alert('Netzwerkfehler beim L√∂schen des Bildes.'); });
  });
});
</script>
{% endblock %}
{% endblock %}
